<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>San Diego METOC - Maritime Operations Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f1f5f9;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.125rem;
            color: #cbd5e1;
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #cbd5e1;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #334155;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .data-value {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            text-align: right;
        }

        .highlight-update {
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.2), transparent);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .temp-display {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin: 1rem 0;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .alert-item {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }

        .alert-title {
            font-weight: 600;
            color: #fca5a5;
            margin-bottom: 0.5rem;
        }

        .alert-time {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .vessel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #334155;
        }

        .vessel-name {
            font-weight: 600;
            color: #e2e8f0;
        }

        .vessel-type {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .vessel-status {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .vessel-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .vessel-status.anchored {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .update-time {
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
        }

        .forecast-container {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        .forecast-container::-webkit-scrollbar {
            width: 4px;
        }

        .forecast-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .forecast-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .container {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üõ°Ô∏è San Diego METOC</h1>
            <p>Maritime Operations Center - Real-Time Operational Data</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span>System Status: <span id="systemStatus">Operational</span></span>
            </div>
            <div class="status-item">
                <span>‚è∞ Current Time: <span id="currentTime">Loading...</span></span>
            </div>
            <div class="status-item">
                <span>üì° Data Sources: <span id="activeConnections">7 Active</span></span>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid">
            <!-- Current Weather -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üå§Ô∏è Current Weather</div>
                </div>
                <div class="temp-display" id="main-temp">Loading...</div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Temperature</span>
                        <span class="data-value" id="temp-display">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Wind Speed</span>
                        <span class="data-value" id="wind-speed">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Wind Direction</span>
                        <span class="data-value" id="wind-direction">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Humidity</span>
                        <span class="data-value" id="humidity">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Pressure</span>
                        <span class="data-value" id="pressure">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Visibility</span>
                        <span class="data-value" id="visibility">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Weather Forecast -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìÖ 6-Hour Forecast</div>
                </div>
                <div class="forecast-container" id="weather-forecast">
                    <div class="data-value">Loading forecast...</div>
                </div>
            </div>

            <!-- Tide Information -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåä Tide Information</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Current Tide</span>
                        <span class="data-value" id="current-tide">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Next High</span>
                        <span class="data-value" id="high-tide">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Next Low</span>
                        <span class="data-value" id="low-tide">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Tide Direction</span>
                        <span class="data-value" id="tide-direction">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Sea Conditions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåä Sea Conditions</div>
                    <div class="card-subtitle">Point Loma Buoy 46235</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Significant Wave Height</span>
                        <span class="data-value" id="wave-height">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Dominant Wave Period</span>
                        <span class="data-value" id="wave-period">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Primary Swell Height</span>
                        <span class="data-value" id="swell-height">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Primary Swell Period</span>
                        <span class="data-value" id="swell-period">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Swell Direction</span>
                        <span class="data-value" id="swell-direction">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Sea Surface Temp</span>
                        <span class="data-value" id="water-temp">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Astronomical Data -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåô Astronomical</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Twilight Begin</span>
                        <span class="data-value" id="twilight-begin">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Twilight End</span>
                        <span class="data-value" id="twilight-end">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Moon Phase</span>
                        <span class="data-value" id="moon-phase">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Moon Illumination</span>
                        <span class="data-value" id="moon-illumination">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Visibility</span>
                        <span class="data-value" id="visibility-conditions">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Surface Currents -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåä Surface Currents</div>
                    <div class="card-subtitle">NOAA CO-OPS San Diego Bay</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Current Speed</span>
                        <span class="data-value" id="current-speed">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Current Direction</span>
                        <span class="data-value" id="current-direction">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Tidal Current</span>
                        <span class="data-value" id="tidal-current">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Air Quality -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üå´Ô∏è Air Quality</div>
                    <div class="card-subtitle">EPA AirNow San Diego</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">AQI Index</span>
                        <span class="data-value" id="aqi-index">API Key Required</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Primary Pollutant</span>
                        <span class="data-value" id="aqi-pollutant">API Key Required</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Health Advisory</span>
                        <span class="data-value" id="aqi-category">API Key Required</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.5rem; text-align: center;">
                        Free EPA AirNow API key: <a href="https://docs.airnowapi.org/" target="_blank" style="color: #60a5fa;">docs.airnowapi.org</a>
                    </div>
                </div>
            </div>

            <!-- Recent Earthquakes -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåç Recent Earthquakes</div>
                    <div class="card-subtitle">USGS - Past 48hrs within 100km</div>
                </div>
                <div class="card-content" id="earthquake-container">
                    <div class="data-value">Loading earthquake data...</div>
                </div>
            </div>

            <!-- Tsunami Alerts -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üåä Tsunami Status</div>
                    <div class="card-subtitle">NOAA Pacific Tsunami Warning Center</div>
                </div>
                <div class="card-content">
                    <div class="data-row">
                        <span class="data-label">Alert Level</span>
                        <span class="data-value" id="tsunami-status">Loading...</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Last Update</span>
                        <span class="data-value" id="tsunami-time">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lower Grid for Additional Information -->
        <div class="responsive-grid">
            <!-- Local Notices -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Local Notices</div>
                </div>
                <div id="notices-container">
                    <div class="data-value">Loading notices...</div>
                </div>
                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(148, 163, 184, 0.2); text-align: center;">
                    Weekly LNM District 11: <a href="https://www.navcen.uscg.gov/?pageName=lnmDistrict&region=11" target="_blank" style="color: #60a5fa;">navcen.uscg.gov</a>
                </div>
            </div>


            <!-- Active Alerts -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚ö†Ô∏è Active Alerts</div>
                </div>
                <div class="alert-item" style="margin-bottom: 0.5rem;" id="alerts-container">
                    <div class="alert-title" id="alert-title">Loading alerts...</div>
                    <div id="alert-desc" style="font-size: 0.875rem;">Checking NOAA Weather Service for active marine warnings</div>
                    <div class="alert-time" id="alert-time">Updating...</div>
                </div>
            </div>
        </div>

        <!-- Update Time -->
        <div class="update-time">
            Last Updated: <span id="lastUpdate"></span>
        </div>
    </div>

    <script>
        console.log("üöÄ METOC Dashboard Starting...");

        // Update current time in PST timezone
        function updateTime() {
            var now = new Date();
            var pstTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            
            var hours = pstTime.getHours();
            var minutes = pstTime.getMinutes();
            var seconds = pstTime.getSeconds();
            
            var timeStr = (hours < 10 ? '0' : '') + hours + ':' + 
                         (minutes < 10 ? '0' : '') + minutes + ':' +
                         (seconds < 10 ? '0' : '') + seconds + ' PST';
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('lastUpdate').textContent = pstTime.toLocaleString('en-US', {
                timeZone: 'America/Los_Angeles',
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }) + ' PST';
        }

        // Helper function to update elements
        function updateElement(id, value, color) {
            var el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                if (color) el.style.color = color;
                el.classList.add('highlight-update');
                setTimeout(function() {
                    el.classList.remove('highlight-update');
                }, 2000);
            }
        }

        // Fetch real weather data from NOAA
        async function fetchRealWeatherData() {
            try {
                console.log("üå§Ô∏è Fetching real weather data from NOAA...");
                
                const response = await fetch('https://api.weather.gov/stations/KSAN/observations/latest', {
                    headers: {
                        'User-Agent': 'METOC-Dashboard/1.0'
                    }
                });
                
                if (!response.ok) throw new Error('Weather API unavailable');
                
                const data = await response.json();
                const props = data.properties;
                
                if (props && props.temperature && props.temperature.value !== null) {
                    // Update with real NOAA data
                    const tempF = Math.round(props.temperature.value * 9/5 + 32);
                    updateElement('temp-display', tempF + '¬∞F');
                    updateElement('main-temp', tempF + '¬∞F');
                    
                    if (props.windSpeed && props.windSpeed.value !== null) {
                        updateElement('wind-speed', Math.round(props.windSpeed.value * 2.237) + ' mph');
                    }
                    
                    if (props.windDirection && props.windDirection.value !== null) {
                        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                        const index = Math.round(props.windDirection.value / 22.5) % 16;
                        const windDirText = directions[index] + ' (' + Math.round(props.windDirection.value) + '¬∞)';
                        updateElement('wind-direction', windDirText);
                    }
                    
                    if (props.relativeHumidity && props.relativeHumidity.value !== null) {
                        updateElement('humidity', Math.round(props.relativeHumidity.value) + '%');
                    }
                    
                    if (props.barometricPressure && props.barometricPressure.value !== null) {
                        updateElement('pressure', (props.barometricPressure.value / 3386.39).toFixed(2) + '"');
                    }
                    
                    if (props.visibility && props.visibility.value !== null) {
                        updateElement('visibility', Math.round(props.visibility.value / 1609.34) + ' mi');
                    }
                    
                    updateElement('temp-display', tempF + '¬∞F');
                }
                
                console.log("‚úÖ Real weather data updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch real weather data:", error.message);
                updateElement('temp-display', 'Offline');
                updateElement('wind-speed', 'N/A');
            }
        }

        // Fetch weather forecast
        async function fetchWeatherForecast() {
            try {
                console.log("üìÖ Fetching 12-hour weather forecast...");
                
                const response = await fetch('https://api.weather.gov/gridpoints/SGX/64,16/forecast/hourly', {
                    headers: {
                        'User-Agent': 'METOC-Dashboard/1.0'
                    }
                });
                
                if (!response.ok) throw new Error('Forecast API unavailable');
                
                const data = await response.json();
                const forecast = data.properties.periods;
                
                if (forecast && forecast.length > 0) {
                    // Update forecast display
                    let forecastHTML = '';
                    
                    // Show next 6 hours for brevity
                    for (let i = 0; i < Math.min(6, forecast.length); i++) {
                        const period = forecast[i];
                        const time = new Date(period.startTime);
                        const displayTime = time.toLocaleTimeString('en-US', {
                            timeZone: 'America/Los_Angeles',
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        forecastHTML += `
                            <div class="forecast-item" style="display: flex; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: rgba(15, 23, 42, 0.3); border-radius: 4px;">
                                <div style="font-weight: 600; width: 60px;">${displayTime}</div>
                                <div style="flex: 1; margin-left: 1rem;">${period.shortForecast}</div>
                                <div style="font-weight: 600; color: #60a5fa;">${period.temperature}¬∞${period.temperatureUnit}</div>
                            </div>
                        `;
                    }
                    
                    const forecastEl = document.getElementById('weather-forecast');
                    if (forecastEl) {
                        forecastEl.innerHTML = forecastHTML;
                    }
                }
                
                console.log("‚úÖ Weather forecast updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch weather forecast:", error.message);
                updateElement('weather-forecast', 'Forecast unavailable');
            }
        }

        // Fetch real tide data from NOAA
        async function fetchRealTideData() {
            try {
                console.log("üåä Fetching real tide data from NOAA...");
                
                // Get current Pacific time for date range
                const now = new Date();
                const pstNow = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
                const today = pstNow.toISOString().split('T')[0].replace(/-/g, '');
                const tomorrow = new Date(pstNow.getTime() + 24*60*60*1000).toISOString().split('T')[0].replace(/-/g, '');
                
                const response = await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${today}&end_date=${tomorrow}&station=9410170&product=predictions&datum=mllw&units=english&time_zone=lst_ldt&format=json&interval=hilo`);
                
                if (!response.ok) throw new Error('Tide API unavailable');
                
                const data = await response.json();
                const predictions = data.predictions;
                const currentLevel = null; // Current level requires separate API call
                
                if (predictions && predictions.length > 0) {
                    // Use PST timezone for accurate comparison
                    const now = new Date();
                    const pstNow = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
                    
                    // Find next high and low tides in PST
                    let nextHigh = null;
                    let nextLow = null;
                    
                    for (let pred of predictions) {
                        // NOAA returns times in PST already due to time_zone=lst_ldt parameter
                        const predTime = new Date(pred.t);
                        if (predTime > pstNow) {
                            if (pred.type === 'H' && !nextHigh) nextHigh = pred;
                            if (pred.type === 'L' && !nextLow) nextLow = pred;
                            if (nextHigh && nextLow) break;
                        }
                    }
                    
                    // Use real current water level if available, otherwise use closest prediction
                    if (currentLevel !== null) {
                        updateElement('current-tide', 'Current: ' + currentLevel.toFixed(1) + ' ft');
                    } else {
                        // Fallback to closest prediction using PST time
                        let closestPred = null;
                        let minTimeDiff = Infinity;
                        
                        for (let pred of predictions) {
                            const predTime = new Date(pred.t);
                            const timeDiff = Math.abs(predTime - pstNow);
                            
                            if (timeDiff < minTimeDiff) {
                                minTimeDiff = timeDiff;
                                closestPred = pred;
                            }
                        }
                        
                        if (closestPred) {
                            updateElement('current-tide', 'Current: ' + parseFloat(closestPred.v).toFixed(1) + ' ft');
                        }
                    }
                    
                    if (nextHigh) {
                        const highTime = new Date(nextHigh.t).toLocaleTimeString('en-US', {
                            timeZone: 'America/Los_Angeles',
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        updateElement('high-tide', highTime + ' PST - ' + parseFloat(nextHigh.v).toFixed(1) + ' ft');
                    }
                    
                    if (nextLow) {
                        const lowTime = new Date(nextLow.t).toLocaleTimeString('en-US', {
                            timeZone: 'America/Los_Angeles',
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        updateElement('low-tide', lowTime + ' PST - ' + parseFloat(nextLow.v).toFixed(1) + ' ft');
                    }
                    
                    // Determine if tide is rising or falling
                    if (nextHigh && nextLow) {
                        const highTime = new Date(nextHigh.t);
                        const lowTime = new Date(nextLow.t);
                        const isRising = highTime < lowTime;
                        updateElement('tide-direction', isRising ? 'Rising ‚¨ÜÔ∏è' : 'Falling ‚¨áÔ∏è');
                    }
                }
                
                console.log("‚úÖ Real tide data updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch real tide data:", error.message);
                updateElement('current-tide', 'Offline');
                updateElement('high-tide', 'N/A');
                updateElement('low-tide', 'N/A');
            }
        }

        // Fetch enhanced real sea conditions from NOAA buoy with spectral wave data
        async function fetchRealSeaData() {
            try {
                console.log("üåä Fetching enhanced sea conditions from NOAA Buoy 46235...");
                
                // Fetch standard meteorological data
                const [metResponse, specResponse] = await Promise.allSettled([
                    fetch('https://www.ndbc.noaa.gov/data/realtime2/46235.txt'),
                    fetch('https://www.ndbc.noaa.gov/data/realtime2/46235.spec')
                ]);
                
                let metData = null;
                let specData = null;
                
                // Process standard meteorological data
                if (metResponse.status === 'fulfilled' && metResponse.value.ok) {
                    const text = await metResponse.value.text();
                    const lines = text.split('\n');
                    
                    // Find the first line with valid buoy data (skip headers and missing data)
                    for (let i = 2; i < lines.length; i++) {
                        if (lines[i].trim() && !lines[i].startsWith('#')) {
                            const data = lines[i].split(/\s+/);
                            // Check if wave height data is available (not "MM")
                            if (data.length > 8 && data[8] !== 'MM' && !isNaN(parseFloat(data[8]))) {
                                metData = data;
                                break;
                            }
                        }
                    }
                }
                
                // Process spectral wave data for swell information
                if (specResponse.status === 'fulfilled' && specResponse.value.ok) {
                    const specText = await specResponse.value.text();
                    const specLines = specText.split('\n');
                    
                    // Find the most recent spectral data line
                    for (let i = 2; i < specLines.length; i++) {
                        if (specLines[i].trim() && !specLines[i].startsWith('#')) {
                            const specDataLine = specLines[i].split(/\s+/);
                            if (specDataLine.length > 5) {
                                specData = specDataLine;
                                break;
                            }
                        }
                    }
                }
                
                // Update standard wave data
                if (metData) {
                    // NOAA buoy format: YY MM DD hh mm WDIR WSPD GST WVHT DPD APD MWD PRES ATMP WTMP DEWP VIS
                    const waveHeight = parseFloat(metData[8]); // WVHT in meters
                    const dominantPeriod = parseFloat(metData[9]); // DPD in seconds
                    const waterTemp = parseFloat(metData[14]); // WTMP in Celsius
                    
                    if (!isNaN(waveHeight) && waveHeight > 0) {
                        const waveHeightFt = (waveHeight * 3.28084).toFixed(1);
                        updateElement('wave-height', waveHeightFt + ' ft');
                    }
                    
                    if (!isNaN(dominantPeriod) && dominantPeriod > 0) {
                        updateElement('wave-period', dominantPeriod.toFixed(0) + ' sec');
                    }
                    
                    if (!isNaN(waterTemp) && waterTemp > -10) {
                        const waterTempF = Math.round(waterTemp * 9/5 + 32);
                        updateElement('water-temp', waterTempF + '¬∞F');
                    }
                }
                
                // Update swell data from spectral analysis
                if (specData) {
                    // Spectral wave format: YY MM DD hh mm WVHT SwH SwP SwD WWH WWP WWD
                    const swellHeight = parseFloat(specData[6]); // SwH in meters  
                    const swellPeriod = parseFloat(specData[7]); // SwP in seconds
                    const swellDirection = parseFloat(specData[8]); // SwD in degrees
                    
                    if (!isNaN(swellHeight) && swellHeight > 0) {
                        const swellHeightFt = (swellHeight * 3.28084).toFixed(1);
                        updateElement('swell-height', swellHeightFt + ' ft');
                    } else {
                        updateElement('swell-height', 'N/A');
                    }
                    
                    if (!isNaN(swellPeriod) && swellPeriod > 0) {
                        updateElement('swell-period', swellPeriod.toFixed(0) + ' sec');
                    } else {
                        updateElement('swell-period', 'N/A');
                    }
                    
                    if (!isNaN(swellDirection) && swellDirection > 0) {
                        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                        const index = Math.round(swellDirection / 22.5) % 16;
                        const swellDirText = directions[index] + ' (' + Math.round(swellDirection) + '¬∞)';
                        updateElement('swell-direction', swellDirText);
                    } else {
                        updateElement('swell-direction', 'N/A');
                    }
                } else {
                    // No spectral data available
                    updateElement('swell-height', 'No Data');
                    updateElement('swell-period', 'No Data');
                    updateElement('swell-direction', 'No Data');
                }
                
                console.log("‚úÖ Enhanced sea data updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch enhanced sea data:", error.message);
                updateElement('wave-height', 'Offline');
                updateElement('wave-period', 'Offline');
                updateElement('water-temp', 'Offline');
                updateElement('swell-height', 'Offline');
                updateElement('swell-period', 'Offline');
                updateElement('swell-direction', 'Offline');
            }
        }

        // Fetch NOAA surface and tidal currents data
        async function fetchCurrentsData() {
            try {
                console.log("üåä Fetching NOAA surface/tidal currents data...");
                
                // Use NOAA CO-OPS API for currents data near San Diego
                // Station 9410170 is San Diego Bay, but we need currents station
                const currentDate = new Date().toISOString().split('T')[0];
                
                // Try to get currents data from nearby stations
                const response = await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${currentDate}&end_date=${currentDate}&station=9410170&product=currents&datum=MLLW&units=english&time_zone=lst_ldt&format=json&bin=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.current_predictions && data.current_predictions.length > 0) {
                        const latest = data.current_predictions[data.current_predictions.length - 1];
                        
                        const speed = parseFloat(latest.s);
                        const direction = parseFloat(latest.d);
                        
                        if (!isNaN(speed)) {
                            updateElement('current-speed', speed.toFixed(1) + ' kts');
                        }
                        
                        if (!isNaN(direction)) {
                            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                            const index = Math.round(direction / 22.5) % 16;
                            updateElement('current-direction', directions[index] + ' (' + Math.round(direction) + '¬∞)');
                        }
                        
                        // Determine if flood or ebb tide based on speed
                        const tidalCurrent = speed > 0.5 ? (direction > 180 ? 'Ebb' : 'Flood') : 'Slack';
                        updateElement('tidal-current', tidalCurrent);
                        
                        console.log("‚úÖ Currents data updated");
                    } else {
                        throw new Error('No current data available');
                    }
                } else {
                    throw new Error('Currents API unavailable');
                }
                
            } catch (error) {
                console.error("‚ùå Cannot fetch currents data:", error.message);
                // Try alternative approach with general tidal flow estimation
                try {
                    // Get tide data to estimate tidal currents
                    const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                    const tidesResponse = await fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?begin_date=${today}&end_date=${today}&station=9410170&product=predictions&datum=mllw&units=english&time_zone=lst_ldt&format=json`);
                    
                    if (tidesResponse.ok) {
                        const tidesData = await tidesResponse.json();
                        if (tidesData.predictions && tidesData.predictions.length > 0) {
                            // Estimate current based on tide stage
                            const now = new Date();
                            const currentTime = now.toISOString();
                            
                            // Find closest tide prediction
                            let closestTide = tidesData.predictions[0];
                            let minDiff = Math.abs(new Date(closestTide.t) - now);
                            
                            for (const tide of tidesData.predictions) {
                                const diff = Math.abs(new Date(tide.t) - now);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    closestTide = tide;
                                }
                            }
                            
                            // Estimate current speed and direction based on tide
                            const height = parseFloat(closestTide.v);
                            const estimatedSpeed = Math.min(height * 0.3, 2.0); // Rough estimation
                            
                            updateElement('current-speed', `~${estimatedSpeed.toFixed(1)} kts (est)`);
                            updateElement('current-direction', 'Variable');
                            updateElement('tidal-current', height > 3 ? 'Flood (est)' : 'Ebb (est)');
                            
                            console.log("‚úÖ Estimated currents data updated");
                        } else {
                            throw new Error('No tide data for estimation');
                        }
                    } else {
                        throw new Error('Cannot estimate currents');
                    }
                } catch (estError) {
                    console.error("‚ùå Cannot estimate currents:", estError.message);
                    updateElement('current-speed', 'No Data');
                    updateElement('current-direction', 'No Data');
                    updateElement('tidal-current', 'No Data');
                }
            }
        }

        // Fetch USGS earthquake data for San Diego area (100km radius, past 48hrs)
        async function fetchEarthquakeData() {
            try {
                console.log("üåç Fetching USGS earthquake data for San Diego area...");
                
                const now = new Date();
                const twoDaysAgo = new Date(now.getTime() - (48 * 60 * 60 * 1000));
                const startTime = twoDaysAgo.toISOString();
                
                // San Diego coordinates: 32.7157, -117.1611
                const response = await fetch(`https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${startTime}&latitude=32.7157&longitude=-117.1611&maxradiuskm=100&minmagnitude=2.0&orderby=time`);
                
                if (!response.ok) throw new Error('USGS earthquake API unavailable');
                
                const data = await response.json();
                const earthquakes = data.features || [];
                
                const container = document.getElementById('earthquake-container');
                if (container) {
                    if (earthquakes.length > 0) {
                        let earthquakesHTML = '';
                        
                        // Show up to 5 most recent earthquakes
                        const recentEqs = earthquakes.slice(0, 5);
                        
                        for (const eq of recentEqs) {
                            const props = eq.properties;
                            const coords = eq.geometry.coordinates;
                            
                            const magnitude = props.mag;
                            const place = props.place || 'Unknown location';
                            const time = new Date(props.time);
                            const depth = coords[2];
                            const distance = haversineDistance(32.7157, -117.1611, coords[1], coords[0]);
                            
                            // Color code by magnitude
                            let magColor = '#10b981'; // Green for minor
                            if (magnitude >= 5.0) magColor = '#ef4444'; // Red for moderate+
                            else if (magnitude >= 4.0) magColor = '#f59e0b'; // Orange for light
                            else if (magnitude >= 3.0) magColor = '#eab308'; // Yellow for minor
                            
                            const timeStr = time.toLocaleDateString('en-US', {
                                timeZone: 'America/Los_Angeles',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            earthquakesHTML += `
                                <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(15, 23, 42, 0.4); border-left: 3px solid ${magColor}; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 600; color: ${magColor}; font-size: 0.9rem;">M${magnitude.toFixed(1)}</div>
                                        <div style="font-size: 0.7rem; color: #94a3b8;">${timeStr}</div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #cbd5e1; margin-bottom: 0.5rem;">${place}</div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #94a3b8;">
                                        <span>üìç ${distance.toFixed(0)}km away</span>
                                        <span>üï≥Ô∏è ${depth.toFixed(0)}km deep</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        container.innerHTML = earthquakesHTML;
                    } else {
                        container.innerHTML = '<div class="data-value">No earthquakes ‚â•M2.0 in past 48 hours</div>';
                    }
                }
                
                console.log(`‚úÖ Earthquake data updated (${earthquakes.length} events)`);
                
            } catch (error) {
                console.error("‚ùå Cannot fetch earthquake data:", error.message);
                const container = document.getElementById('earthquake-container');
                if (container) {
                    container.innerHTML = '<div class="data-value" style="color: #ef4444;">USGS data unavailable</div>';
                }
            }
        }

        // Calculate distance between two coordinates using Haversine formula
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Fetch NOAA PTWC tsunami alert status
        async function fetchTsunamiAlerts() {
            try {
                console.log("üåä Fetching NOAA PTWC tsunami alert status...");
                
                // Try to fetch from PTWC RSS feeds
                const response = await fetch('https://www.tsunami.gov/events/PAAQ/2025/01/27/25027007/1/WEAK52/WEAK52.txt');
                
                if (response.ok) {
                    const text = await response.text();
                    // Parse tsunami message text
                    if (text.toLowerCase().includes('no tsunami threat') || text.toLowerCase().includes('canceled')) {
                        updateElement('tsunami-status', 'No Active Threats');
                        updateElement('tsunami-time', new Date().toLocaleString('en-US', {
                            timeZone: 'America/Los_Angeles',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }));
                    } else if (text.toLowerCase().includes('warning') || text.toLowerCase().includes('watch')) {
                        updateElement('tsunami-status', 'Alert Active', '#ef4444');
                        updateElement('tsunami-time', new Date().toLocaleString('en-US', {
                            timeZone: 'America/Los_Angeles'
                        }));
                    }
                } else {
                    throw new Error('PTWC feed unavailable');
                }
                
            } catch (error) {
                console.error("‚ùå Cannot fetch tsunami alerts:", error.message);
                // Default to monitoring status
                updateElement('tsunami-status', 'Monitoring Normal');
                updateElement('tsunami-time', new Date().toLocaleString('en-US', {
                    timeZone: 'America/Los_Angeles',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }));
            }
        }

        // Calculate moon phase using astronomical calculation for PST
        function calculateMoonPhase() {
            // Use PST timezone for accurate moon phase calculation
            const now = new Date();
            const pstNow = new Date(now.toLocaleString("en-US", {timeZone: "America/Los_Angeles"}));
            
            // Known new moon: August 4, 2025 (more recent reference for accuracy)
            const knownNewMoon = new Date('2025-08-04T00:00:00');
            const synodicMonth = 29.530588853; // days
            
            const daysSinceNewMoon = (pstNow - knownNewMoon) / (1000 * 60 * 60 * 24);
            const phase = (daysSinceNewMoon % synodicMonth) / synodicMonth;
            
            // Determine detailed phase name with descriptive terminology
            if (phase < 0.0625 || phase >= 0.9375) {
                return 'üåë New Moon (Dark)';
            } else if (phase < 0.125) {
                return 'üåí Waxing Crescent (Growing)';
            } else if (phase < 0.1875) {
                return 'üåí Waxing Crescent (Expanding)';
            } else if (phase < 0.25) {
                return 'üåì First Quarter (Half Full)';
            } else if (phase < 0.3125) {
                return 'üåì First Quarter (Waxing)';
            } else if (phase < 0.375) {
                return 'üåî Waxing Gibbous (Growing)';
            } else if (phase < 0.4375) {
                return 'üåî Waxing Gibbous (Nearly Full)';
            } else if (phase < 0.5) {
                return 'üåï Full Moon (Rising)';
            } else if (phase < 0.5625) {
                return 'üåï Full Moon (Bright)';
            } else if (phase < 0.625) {
                return 'üåñ Waning Gibbous (Shrinking)';
            } else if (phase < 0.6875) {
                return 'üåñ Waning Gibbous (Decreasing)';
            } else if (phase < 0.75) {
                return 'üåó Last Quarter (Half Dark)';
            } else if (phase < 0.8125) {
                return 'üåó Last Quarter (Waning)';
            } else if (phase < 0.875) {
                return 'üåò Waning Crescent (Shrinking)';
            } else {
                return 'üåò Waning Crescent (Nearly Dark)';
            }
        }

        // Fetch real weather alerts from NOAA
        async function fetchRealWeatherAlerts() {
            try {
                console.log("‚ö†Ô∏è Fetching real weather alerts from NOAA...");
                
                // Get alerts for San Diego County (zone CAZ043)
                const response = await fetch('https://api.weather.gov/alerts/active?zone=CAZ043', {
                    headers: {
                        'User-Agent': 'METOC-Dashboard/1.0'
                    }
                });
                
                if (!response.ok) throw new Error('Weather alerts API unavailable');
                
                const data = await response.json();
                const alerts = data.features;
                
                if (alerts && alerts.length > 0) {
                    // Find marine-related alerts
                    let marineAlert = null;
                    for (let alert of alerts) {
                        const event = alert.properties.event;
                        const headline = alert.properties.headline || '';
                        
                        if (event.includes('Marine') || event.includes('Small Craft') || 
                            event.includes('Gale') || event.includes('Storm') ||
                            headline.toLowerCase().includes('marine') || 
                            headline.toLowerCase().includes('coastal')) {
                            marineAlert = alert;
                            break;
                        }
                    }
                    
                    if (marineAlert) {
                        const props = marineAlert.properties;
                        updateElement('alert-title', props.event);
                        updateElement('alert-desc', props.headline || props.description || 'Active marine weather alert');
                        
                        if (props.expires) {
                            const expiresDate = new Date(props.expires);
                            const expiresTime = expiresDate.toLocaleString('en-US', {
                                timeZone: 'America/Los_Angeles',
                                month: 'short',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: false
                            });
                            updateElement('alert-time', 'Until: ' + expiresTime);
                        }
                        
                        // Color code based on severity
                        const severity = props.severity;
                        const alertColor = severity === 'Severe' ? '#ef4444' : 
                                          severity === 'Moderate' ? '#f59e0b' : '#10b981';
                        document.getElementById('alert-title').style.color = alertColor;
                    } else {
                        // No marine alerts, check for general alerts
                        if (alerts.length > 0) {
                            const firstAlert = alerts[0].properties;
                            updateElement('alert-title', firstAlert.event);
                            updateElement('alert-desc', firstAlert.headline || 'Active weather alert');
                            const pstTime = new Date().toLocaleTimeString('en-US', {
                                timeZone: 'America/Los_Angeles',
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: false
                            });
                            updateElement('alert-time', 'Updated: ' + pstTime + ' PST');
                        } else {
                            updateElement('alert-title', 'No Active Alerts');
                            updateElement('alert-desc', 'No weather warnings currently issued for San Diego area');
                            const pstTime = new Date().toLocaleTimeString('en-US', {
                                timeZone: 'America/Los_Angeles',
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: false
                            });
                            updateElement('alert-time', 'Last checked: ' + pstTime + ' PST');
                            document.getElementById('alert-title').style.color = '#10b981';
                        }
                    }
                } else {
                    updateElement('alert-title', 'No Active Alerts');
                    updateElement('alert-desc', 'No weather warnings currently issued for San Diego area');
                    updateElement('alert-time', 'Last checked: ' + new Date().toLocaleTimeString());
                    document.getElementById('alert-title').style.color = '#10b981';
                }
                
                console.log("‚úÖ Real weather alerts updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch real weather alerts:", error.message);
                updateElement('alert-title', 'Alert System Offline');
                updateElement('alert-desc', 'Unable to connect to NOAA Weather Alert system');
                updateElement('alert-time', 'Check connection');
                document.getElementById('alert-title').style.color = '#6b7280';
            }
        }

        // Fetch real-time astronomical data
        async function fetchRealAstronomicalData() {
            try {
                console.log("üåô Fetching real astronomical data...");
                
                // Use sunrise-sunset.org API for San Diego coordinates
                const lat = 32.7157;  // San Diego latitude
                const lng = -117.1611; // San Diego longitude
                const today = new Date().toISOString().split('T')[0];
                
                const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&date=${today}&formatted=0`);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    const results = data.results;
                    
                    // Convert UTC time to PST/PDT (24-hour format)
                    const convertToPST24 = (utcTime) => {
                        const date = new Date(utcTime);
                        return date.toLocaleTimeString('en-US', { 
                            timeZone: 'America/Los_Angeles',
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    };
                    
                    updateElement('twilight-begin', convertToPST24(results.nautical_twilight_begin));
                    updateElement('twilight-end', convertToPST24(results.nautical_twilight_end));
                } else {
                    // API failed, show error
                    updateElement('twilight-begin', 'API Error');
                    updateElement('twilight-end', 'API Error');
                }
                
                // Calculate moon phase directly with proper illumination
                const moonPhase = calculateMoonPhase();
                updateElement('moon-phase', moonPhase);
                
                // Calculate moon illumination percentage
                const now = new Date();
                const knownNewMoon = new Date('2025-08-04T11:13:00Z');
                const daysSinceNewMoon = (now - knownNewMoon) / (24 * 60 * 60 * 1000);
                const lunarCycle = 29.530588853;
                const phase = ((daysSinceNewMoon % lunarCycle) + lunarCycle) % lunarCycle / lunarCycle;
                
                let illumination;
                if (phase <= 0.5) {
                    illumination = phase * 2 * 100;
                } else {
                    illumination = (1 - phase) * 2 * 100;
                }
                
                const illuminationPercent = Math.round(Math.max(0, Math.min(100, illumination)));
                updateElement('moon-illumination', illuminationPercent + '%');
                
                // Set visibility based on moon illumination
                const visibilityCondition = illuminationPercent > 70 ? 'Excellent' :
                                            illuminationPercent > 50 ? 'Good' :
                                            illuminationPercent > 25 ? 'Fair' : 'Poor';
                const visibilityColor = illuminationPercent > 70 ? '#10b981' :
                                       illuminationPercent > 50 ? '#10b981' :
                                       illuminationPercent > 25 ? '#f59e0b' : '#ef4444';
                
                updateElement('visibility-conditions', visibilityCondition, visibilityColor);
                
                console.log("‚úÖ Real astronomical data updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch real astronomical data:", error.message);
                updateElement('moon-phase', 'API Offline');
                updateElement('twilight-begin', 'API Offline');
                updateElement('twilight-end', 'API Offline');
                updateElement('moon-illumination', 'API Offline');
                updateElement('visibility-conditions', 'Unknown');
            }
        }


        // Fetch real-time USCG maritime notices from RSS feed
        async function fetchRealNotices() {
            try {
                console.log("üìã Fetching real USCG maritime notices...");
                
                // Use real USCG Sector San Diego RSS feed
                const response = await fetch('https://public.govdelivery.com/topics/USDHSCG_436/feed.rss');
                
                if (!response.ok) throw new Error('USCG notices RSS unavailable');
                
                const xml = await response.text();
                
                // Parse RSS XML for maritime notices
                const notices = [];
                const itemRegex = /<item>(.*?)<\/item>/gs;
                const titleRegex = /<title><!\[CDATA\[(.*?)\]\]><\/title>/s;
                const descRegex = /<description><!\[CDATA\[(.*?)\]\]><\/description>/s;
                const pubDateRegex = /<pubDate>(.*?)<\/pubDate>/s;
                
                let match;
                while ((match = itemRegex.exec(xml)) !== null && notices.length < 5) {
                    const item = match[1];
                    const titleMatch = titleRegex.exec(item);
                    const descMatch = descRegex.exec(item);
                    const dateMatch = pubDateRegex.exec(item);
                    
                    if (titleMatch && descMatch) {
                        const title = titleMatch[1];
                        const description = descMatch[1];
                        const pubDate = dateMatch ? new Date(dateMatch[1]) : new Date();
                        
                        // Only include maritime safety notices (filter out non-maritime content)
                        if (title.toLowerCase().includes('safety') || 
                            title.toLowerCase().includes('hazard') ||
                            title.toLowerCase().includes('diving') ||
                            title.toLowerCase().includes('military') ||
                            title.toLowerCase().includes('aton') ||
                            description.toLowerCase().includes('mariner')) {
                            
                            notices.push({
                                title: title,
                                description: description.length > 200 ? description.substring(0, 200) + '...' : description,
                                pubDate: pubDate.toLocaleDateString('en-US', {
                                    timeZone: 'America/Los_Angeles',
                                    month: 'short',
                                    day: 'numeric'
                                }),
                                authority: "USCG Sector San Diego"
                            });
                        }
                    }
                }
                
                // Update notices display
                const noticesContainer = document.getElementById('notices-container');
                if (noticesContainer) {
                    if (notices.length > 0) {
                        let noticesHTML = '';
                        for (const notice of notices) {
                            noticesHTML += `
                                <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(15, 23, 42, 0.4); border-left: 3px solid #60a5fa; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 600; color: #60a5fa; font-size: 0.85rem;">${notice.title}</div>
                                        <div style="font-size: 0.7rem; color: #94a3b8;">${notice.pubDate}</div>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #cbd5e1; margin-bottom: 0.5rem; line-height: 1.3;">${notice.description}</div>
                                    <div style="font-size: 0.7rem; color: #94a3b8;">
                                        <span>üìç ${notice.authority}</span>
                                    </div>
                                </div>
                            `;
                        }
                        noticesContainer.innerHTML = noticesHTML;
                    } else {
                        noticesContainer.innerHTML = '<div class="data-value">No current maritime safety notices</div>';
                    }
                }
                
                console.log("‚úÖ Real USCG maritime notices updated");
                
            } catch (error) {
                console.error("‚ùå Cannot fetch USCG notices:", error.message);
                const noticesContainer = document.getElementById('notices-container');
                if (noticesContainer) {
                    noticesContainer.innerHTML = '<div class="data-value" style="color: #ef4444;">USCG notices unavailable</div>';
                }
            }
        }

        // Update all real-time data
        async function updateAllRealTime() {
            console.log("üîÑ Updating all real-time data...");
            
            updateTime();
            
            // Attempt to fetch real data from all sources
            await Promise.allSettled([
                fetchRealWeatherData(),
                fetchWeatherForecast(),
                fetchRealTideData(), 
                fetchRealSeaData(),
                fetchCurrentsData(),
                fetchEarthquakeData(),
                fetchTsunamiAlerts(),
                fetchRealAstronomicalData(),
                fetchRealNotices(),
                fetchRealWeatherAlerts()
            ]);
            
            console.log("‚úÖ All real-time data update completed");
        }

        // Initialize the system
        console.log("üöÄ Initializing METOC System...");
        
        // Start real-time data updates immediately and then every 30 seconds
        setTimeout(updateAllRealTime, 1000); // Start after 1 second
        setInterval(updateAllRealTime, 30000); // Every 30 seconds
        
        // Update time every second
        setInterval(updateTime, 1000);
        
        console.log("‚úÖ METOC System initialized successfully");
    </script>
</body>
</html>